name: packer

on: workflow_dispatch

env:
  CHECKPOINT_DISABLE: "1"
  PACKER_NO_COLOR: "1"
  PACKER_PLUGIN_PATH: "${{ github.workspace }}/.packer/plugins"
  PACKER_CACHE_DIR: "${{ github.workspace }}/.packer/cache"

jobs:
  butane:
    runs-on: ubuntu-latest
    container:
      image: quay.io/coreos/butane:v0.23.0
      options: --security-opt label=disable
      volumes: ["${{ github.workspace }}:/ws"]
    defaults:
      run:
        working-directory: /ws
    steps:
      - name: Set artifact name
        id: set-artifact-name
        run: echo "ignition-artifact=ignition-config" >> "$GITHUB_OUTPUT"
      - uses: actions/checkout@v4
      - name: Run Butane
        run: |
          cd /ws/files/ignition/ && \
          butane --strict config.bu > config.ign
      - name: Upload Ignition config
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.set-artifact-name.outputs.ignition-artifact }}
          path: /ws/files/ignition/config.ign
          if-no-files-found: error
          retention-days: 1
    outputs:
      ignition-artifact: ${{ steps.set-artifact-name.outputs.ignition-artifact }}
  packer:
    needs: butane
    strategy:
      matrix:
        arch:
          - aarch64
          - x86_64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download Ignition config
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.butane.outputs.ignition-artifact }}
          path: ${{ github.workspace }}/files/ignition
      - name: Setup HashiCorp Packer
        uses: hashicorp/setup-packer@v3
        with:
          version: "1.11.2"
      - name: Prepare Packer cache directories
        run: mkdir -vp ${{ env.PACKER_PLUGIN_PATH }} ${{ env.PACKER_CACHE_DIR }}
      - name: Restore Packer plugins
        id: restore-packer-plugins
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.PACKER_PLUGIN_PATH }}
          key: packer-plugins-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('versions.pkr.hcl') }}
      - name: Run `packer init`
        run: packer init .
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
      - name: Cache Packer plugins
        if: steps.restore-packer-plugins.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ env.PACKER_PLUGIN_PATH }}
          key: ${{ steps.restore-packer-plugins.outputs.cache-primary-key }}
      - name: Run `packer validate`
        run: packer validate -only=coreos.hcloud.${{ matrix.arch }} .
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
      - name: Run `packer build`
        run: packer build -only=coreos.hcloud.${{ matrix.arch }} .
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
      - name: Upload Packer manifest
        uses: actions/upload-artifact@v4
        with:
          name: packer-manifest-${{ matrix.arch }}
          path: packer-manifest-${{ matrix.arch }}.json
          retention-days: 3
